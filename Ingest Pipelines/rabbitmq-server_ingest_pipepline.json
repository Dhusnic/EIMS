{
  "filebeat-8.14.0-rabbitmq-log-pipeline" : {
    "description" : "Pipeline for parsing RabbitMQ logs",
    "processors" : [
      {
        "set" : {
          "field" : "event.ingested",
          "value" : "{{_ingest.timestamp}}"
        }
      },
      {
        "grok" : {
          "patterns" : [
            "%{TIMESTAMP_ISO8601:timestamp} \\[%{WORD:log.level}\\] %{ERL_PID:rabbitmq.log.pid} %{GREEDYMULTILINE:message}"
          ],
          "ignore_missing" : true,
          "field" : "message",
          "pattern_definitions" : {
            "GREEDYMULTILINE" : "(.|\n)*",
            "ERL_PID" : "\\<%{INT}+\\.%{INT}+\\.%{INT}+\\>"
          }
        }
      },
      {
        "grok" : {
          "ignore_missing" : true,
          "ignore_failure" : true,
          "field" : "message",
          "patterns" : [
            "user '%{WORD:user.name}' %{ALLOWED:event.action}",
            "%{DENIED:event.action}: user '%{WORD:user.name}'",
            "%{CLOSING:event.action}%{GREEDYDATA}user: '%{WORD:user.name}'"
          ],
          "pattern_definitions" : {
            "DENIED" : "access denied",
            "CLOSING" : "closing",
            "ALLOWED" : "authenticated and granted access"
          }
        }
      },
      {
        "set" : {
          "field" : "event.action",
          "value" : "logged-in",
          "if" : "ctx.event?.action == \"authenticated and granted access\""
        }
      },
      {
        "set" : {
          "value" : "close-connection",
          "if" : "ctx.event?.action == \"closing\"",
          "field" : "event.action"
        }
      },
      {
        "set" : {
          "value" : "success",
          "if" : "ctx?.event?.action != null && ['logged-in', 'close-connection'].contains(ctx.event.action)",
          "field" : "event.outcome"
        }
      },
      {
        "set" : {
          "if" : "ctx.event?.action == \"access denied\"",
          "field" : "event.action",
          "value" : "logon-failed"
        }
      },
      {
        "set" : {
          "field" : "event.outcome",
          "value" : "failure",
          "if" : "ctx.event?.action == \"logon-failed\""
        }
      },
      {
        "append" : {
          "field" : "event.category",
          "value" : "authentication",
          "if" : "ctx?.event?.action != null && ['logged-in', 'logon-failed'].contains(ctx.event.action)"
        }
      },
      {
        "append" : {
          "field" : "event.type",
          "value" : [
            "start",
            "access"
          ],
          "if" : "ctx?.event?.action != null && ['logged-in', 'logon-failed'].contains(ctx.event.action)"
        }
      },
      {
        "append" : {
          "field" : "event.type",
          "value" : [
            "end",
            "access"
          ],
          "if" : "ctx?.event?.action == 'close-connection'"
        }
      },
      {
        "date" : {
          "formats" : [
            "yyyy-MM-dd HH:mm:ss.SSSSSSZZZZZ"
          ],
          "if" : "ctx.event.timezone == null",
          "field" : "timestamp",
          "target_field" : "@timestamp"
        }
      },
      {
        "date" : {
          "field" : "timestamp",
          "target_field" : "@timestamp",
          "timezone" : "{{ event.timezone }}",
          "formats" : [
            "yyyy-MM-dd HH:mm:ss.SSSSSSZZZZZ"
          ],
          "if" : "ctx.event.timezone != null"
        }
      },
      {
        "remove" : {
          "field" : [
            "timestamp"
          ]
        }
      },
      {
        "set" : {
          "field" : "event.kind",
          "value" : "event"
        }
      }
    ],
    "on_failure" : [
      {
        "set" : {
          "field" : "error.message",
          "value" : "{{ _ingest.on_failure_message }}"
        }
      }
    ]
  }
}
